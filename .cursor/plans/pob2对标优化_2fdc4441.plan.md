---
name: POB2对标优化
overview: 对照 POB2 的 ModStore/条件系统/缓存与本项目现状，按收益优先给出端到端（数据层+核心引擎+前端调用约束）的迭代计划；重点做中等规模改造：引入统一 ModifierStore 并逐步迁移。
todos:
  - id: p0-statkey-align
    content: 统一 StatPool 内部 key 规范，并修正 multiplier breakdown/trace 读取使用的 key，确保计算与明细一致
    status: completed
  - id: p0-cachekey-context
    content: 扩展 CacheKey 纳入 context_flags/context_values（以及必要的版本字段），避免错误命中
    status: completed
    dependencies:
      - p0-statkey-align
  - id: p0-tagregistry-data
    content: 将 TagRegistry 初始化改为从 JSON/DB 导入，替换 pipeline.rs 的硬编码 create_default_registry
    status: completed
  - id: p1-modstore-intro
    content: 新增 Modifier/ModifierStore(ModDB/ModList) 抽象，并让 StatAggregator 同时产出结构化 modifiers
    status: completed
    dependencies:
      - p0-statkey-align
  - id: p1-condition-ast
    content: 升级条件系统为可扩展 AST，并让 ModifierStore 在聚合查询时统一评估条件/PerStat
    status: completed
    dependencies:
      - p1-modstore-intro
  - id: p2-incremental-diff
    content: 缓存中间层（prepared context/modifier store），将 calculate_diff 改为增量合并而非两次全量计算
    status: completed
    dependencies:
      - p1-modstore-intro
  - id: p3-explainability
    content: 完善可解释输出：为每个乘区补齐来源枚举，输出结构更接近 PoB Calculations tab
    status: completed
    dependencies:
      - p1-modstore-intro
---

# POB2 对标优化迭代计划（按优先级）

## 对照结论（POB2 vs 本项目）

- **POB2 的核心优势**（参考 [PathOfBuildingCommunity/PathOfBuilding-PoE2](https://github.com/PathOfBuildingCommunity/PathOfBuilding-PoE2) 以及你提供的 `doc/POB2 项目架构与核心机制分析.md`、`doc/POB2 核心计算系统架构.md`）：
- **统一的 Modifier 存储与查询抽象**：`ModStore -> ModDB/ModList`，并提供 `Sum/More/Flag/Override/Max` 等统一聚合接口；上层计算不直接“手写遍历所有来源”，而是“查询想要的修正”。
- **强条件/乘数系统**：条件标签、PerStat/Multiplier/SkillType 等，使得大量规则数据化而不是硬编码。
- **全局缓存与可重复利用中间结果**：大量计算通过缓存避免重复（尤其 UI 频繁刷新/悬停预览）。
- **可解释性**：计算细节可追溯（类似 PoB 的 Calculations tab）。

- **本项目当前优势**（从 `tli-core/src/pipeline.rs`、`tli-core/src/stats.rs`、`tli-core/src/tags.rs`、`tli-core/src/calculator_cache.rs`、`tli-core/src/lib.rs`）：
- 已有**清晰的 9 阶段管线**与 `debug_trace`。
- 已有 **Tag Interning + 继承展开 + BitSet**（`TagRegistry/ContextTags`）。
- 已有 **More bucket** 思路（支持技能/辅助独立 bucket），并有 **WASM thread_local 全局 LRU**。

- **本项目最值得借鉴/优化的缺口**（对齐 POB2 思路）：

1. **“修正系统抽象层”缺失**：目前 `StatAggregator/StatPool` 仍偏“把所有东西先写进 map”，缺少类似 POB2 `ModStore` 的查询/条件/乘数抽象。
2. **条件/乘数表达力不足**：`ConditionParser` 目前只支持非常简化的比较，且与大多数 stats 处理路径未形成统一机制。
3. **缓存粒度偏粗**：当前主要缓存最终输出（`CalculatorOutput`），`calculate_diff` 也只是两次计算；未缓存/复用中间层（如聚合后的修正列表、已展开 tags、已计算的某些子结果）。
4. **键名规范存在不一致风险**：`StatPool` 内部会把 `mod.inc.xxx` 归一成 `xxx`，但 `pipeline.rs` 的 `build_multiplier_breakdown` 又在用 `mod.inc.xxx` / `mod.more.xxx` 形式读取，容易造成“明细展示与真实计算不一致”。
5. **TagRegistry 仍硬编码初始化**：虽然 `TagRegistry::from_json` 已存在，但 `pipeline.rs` 仍用 `create_default_registry()`，与数据层契约（`tags_registry`）未闭环。

下面的计划按“收益/风险/改动量”排序，符合你选择的 **full_stack + moderate**（端到端覆盖 + 中等规模改造）。

---

## P0（最高优先级，低风险，立刻提升正确性/可解释性）

### 1) 统一 StatKey 规范，保证计算与明细一致

- **目标**：消除 `StatPool` 内部 key 归一化与读取端 key 不一致导致的“明细错误/乘区错报”。
- **建议改法**（二选一）：
- **方案 A（推荐）**：`StatPool` 内部统一存“去前缀后的 key”（如现在），并把所有读取端（尤其 `build_multiplier_breakdown`）改为读取 `dmg.all / dmg.fire / crit.dmg / speed.cast` 这种内部 key。
- **方案 B**：`StatPool` 内部改存“完整 key”，将归一化逻辑前移到更上层（需要改动更大，不适合 P0）。
- **涉及文件**：[`tli-core/src/stats.rs`](tli-core/src/stats.rs)，[`tli-core/src/pipeline.rs`](tli-core/src/pipeline.rs)。

### 2) 修复/补齐缓存键覆盖面

- **目标**：与 POB2 的“缓存必须反映影响计算的输入”一致。
- **当前缺口**：`CacheKey` 未包含 `context_flags/context_values`（你之前暂缓过，但从架构上这是必需的）。
- **涉及文件**：[`tli-core/src/calculator_cache.rs`](tli-core/src/calculator_cache.rs)。

### 3) TagRegistry 数据化加载闭环

- **目标**：把 `pipeline.rs` 的 `create_default_registry()` 替换为“从 JSON/DB 导入”的路径，保证标签体系与数据层一致（POB2 也是数据驱动）。
- **最小落地**：先引入 `tags.json`（或从 Supabase 导出的 tags 配置）在 WASM 内嵌/初始化加载；后续再接 DB 动态加载。
- **涉及文件**：[`tli-core/src/tags.rs`](tli-core/src/tags.rs)，[`tli-core/src/pipeline.rs`](tli-core/src/pipeline.rs)，（数据侧）`supabase/seed.sql` 或 tags 导出文件。

---

## P1（高优先级：引入“ModStore 思路”的中等改造，显著提升扩展性与一致性）

### 4) 引入统一 ModifierStore（对标 POB2 ModStore/ModDB/ModList）

- **目标**：把 `StatAggregator` 产出的结果从“直接写进 StatPool”升级为“收集一组结构化 Modifier”，然后通过统一查询接口得到 `Sum/More/Flag/Override/Max`。
- **建议新增结构**：
- `Modifier { key, kind(Base/Inc/More/Flag/Override), value, bucket_id, source, requirements(tag_ids), condition_expr, scope(skill/actor/target) }`
- `ModifierStore`：
- `ModDB`（按 key 分桶的 HashMap，类似 POB2 ModDB，查询 O(1)）
- `ModList`（临时列表，用于技能/预览增量叠加）
- **迁移路径**：
- 第一步：`StatAggregator` 仍产出 `StatPool`，但同时产出 `Vec<Modifier>`（并行存）；
- 第二步：把 `pipeline.rs` 的关键读取逻辑逐步改用 `ModifierStore` 的 `sum/more/flag` API；
- 第三步：`StatPool` 变为 `ModifierStore` 的一个“视图缓存”或直接退役。
- **涉及文件**：新增 `tli-core/src/modifiers.rs`（或 `mod_store.rs`），改造 [`tli-core/src/stats.rs`](tli-core/src/stats.rs)、[`tli-core/src/pipeline.rs`](tli-core/src/pipeline.rs)。

### 5) 把条件系统升级为统一评估入口

- **目标**：对标 POB2 的条件/乘数标签系统，让“条件生效”不再散落在若干 if 分支。
- **最小可用（moderate）**：
- 先统一支持：`Flag(condition)`、`Value(condition)`、以及 `PerStat`（例如“每 X 点敏捷 +Y%”）
- 条件表达式不追求 PoB 全量语法，但要可扩展（AST + 解释执行）。
- **涉及文件**：[`tli-core/src/stats.rs`](tli-core/src/stats.rs)（现有 `ConditionParser`）、（可选新增）`tli-core/src/condition_ast.rs`。

---

## P2（中优先级：缓存与增量计算，优化 UI 悬停与批量对比）

### 6) 缓存中间层：复用“聚合结果/已展开 tags/ModifierStore”

- **目标**：对标 POB2 的“缓存不仅是最终值”，而是缓存可复用的中间结构。
- **建议**：
- 缓存 `PreparedContext { expanded_tag_set, modifier_store, stat_views... }` 或至少缓存 `modifier_store`。
- `calculate_diff` 改为：复用 base 的 prepared 结果，仅对 preview item 产生的 modifiers 做增量合并，然后跑后续阶段。
- **涉及文件**：[`tli-core/src/calculator_cache.rs`](tli-core/src/calculator_cache.rs)、[`tli-core/src/pipeline.rs`](tli-core/src/pipeline.rs)、[`tli-core/src/lib.rs`](tli-core/src/lib.rs)。

### 7) Cache 失效策略与版本化

- **目标**：避免“数据更新后缓存仍命中旧逻辑”。
- **建议**：为 `CacheKey` 增加 `engine_version`/`data_version`（tags/skills/meta 变更时 bump）。

---

## P3（中低优先级：可解释性与工程质量补强）

### 8) 统一“可解释输出”模型（对标 PoB Calculations tab）

- **目标**：让用户在 UI 看到“某一项 DPS 来自哪些 modifiers”，而不仅是乘区总乘。
- **建议**：
- `DamageBreakdown` 中补齐每个 zone 的 sources（现在 More zone 仍是简化版）。
- `ModifierStore` 天然支持按 key 枚举来源，顺势实现全链路溯源。
- **涉及文件**：[`tli-core/src/types.rs`](tli-core/src/types.rs)、[`tli-core/src/pipeline.rs`](tli-core/src/pipeline.rs)。

### 9) 防御性编程与错误模型

- **目标**：减少 `unwrap_or(0)` 这类潜在“静默错”的路径，提供明确错误/告警。
- **涉及文件**：[`tli-core/src/pipeline.rs`](tli-core/src/pipeline.rs)、[`tli-core/src/tags.rs`](tli-core/src/tags.rs)。

---

## P4（可选：更接近 POB2 的长期演进）

### 10) 多 Actor/召唤物/敌人环境隔离（POB2 的 env/actor 思路）

- **目标**：为“召唤物/图腾/多技能组”预留结构。
- **建议**：引入 `ActorContext` 与作用域（player/minion/target），ModifierStore 支持 scope。

---

## 里程碑验收方式（每阶段都可独立验收）

- **P0**：
- `MultiplierBreakdown` 的 key 读取与真实计算一致；
- cache key 对 `context_flags/context_values` 变化能区分；
- TagRegistry 可从 JSON 初始化且与 DB/seed 一致。
- **P1**：
- 新增 `ModifierStore` 且至少替换 3-5 个关键查询点（如 `dmg.all`、`crit`、`speed`）；
- 条件系统能覆盖典型场景（移动/低血/每层祝福等）。
- **P2**：
- `calculate_diff` 能复用中间结果，悬停预览减少重复聚合。

---

## 参考

- POB2 仓库： [PathOfBuildingCommunity/PathOfBuilding-PoE2](https://github.com/PathOfBuildingCommunity/PathOfBuilding-PoE2)
- 本项目规划：[`doc/火炬之光：无限 BD 决策辅助系统 - 开发规划 (V2.6).md`](doc/火炬之光：无限 BD 决策辅助系统 - 开发规划 \(V2.6\).md)(doc/火炬之光：无限 BD 决策辅助系统 - 开发规划 \(V2.6\).md)(doc/火炬之光：无限 BD 决策辅助系统 - 开发规划 (V2.6).md)
- 本项目开发日志：[`doc/开发日志.md`](doc/开发日志.md)