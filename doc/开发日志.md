# TLI BD 决策辅助系统 - 开发日志

> 本文档记录项目开发过程中的核心决策、功能变更、遇到的问题及解决方案。
> 供后续 AI Agents 进行 Review 或项目重构时参考。

---

## 项目元信息

| 项目名称 | TLI BD 决策辅助系统 |
|---------|-------------------|
| 版本 | v0.1.0 |
| 创建日期 | 2024-12-09 |
| 最后更新 | 2024-12-09 |
| 规划文档 | `doc/火炬之光：无限 BD 决策辅助系统 - 开发规划 (V2.6).md` |

---

## 开发日志

### 2024-12-09: 项目初始化 (Agent A + Agent B)

#### 本次完成的工作

按照 V2.6 开发规划，完成了 **Agent A (数据库层)** 和 **Agent B (计算引擎)** 的基础实现。

**前端 UI (Agent C) 按要求暂缓开发。**

### 2025-01-07: 编译修复与本地验证

#### 处理事项
- 修复 `StatAggregator` 局部属性聚合的借用冲突：局部词缀直接作用于 `local_pool`，避免 clone 造成的无效修改。
- 清理未使用的导入并恢复转化规则中的 `StatPool` 引入，消除编译错误。
- 去除冗余 `mut`，保持代码整洁。
- 在可联网环境下执行 `cargo check` 已通过。

### 2025-12-09: 完整编译测试通过

#### 修复事项
- **ts-rs API 更新**：将 `export_all()` 改为 `export()`（ts-rs 7.x 版本变更）
- **武器攻速默认值**：修复 `calculate_rate` 函数中 `weapon.base_speed` 未设置时返回 0 导致 DPS 为 0 的问题，默认攻速改为 1.0
- **wasm-opt 兼容问题**：禁用 wasm-opt 优化器（旧版本不支持 bulk memory 操作）

#### 测试结果
- ✅ `cargo test`: 27/27 测试通过
- ✅ `wasm-pack build`: 成功生成 `tli_core.wasm`

#### 产出文件
```
pkg/
├── tli_core.wasm         # 核心 WASM 模块
├── tli_core.js           # JavaScript 胶水代码
├── tli_core.d.ts         # TypeScript 类型定义
├── tli_core_bg.wasm.d.ts # WASM 背景类型
└── package.json          # NPM 包配置
```

#### 仍存在的告警
- ts-rs 无法解析部分 `#[serde(default = "...")]` 属性（仅警告，不影响编译）

#### 核心架构决策

1. **三层分离架构**
   - Agent A: Supabase (PostgreSQL) - 数据存储
   - Agent B: Rust/WASM - 纯函数计算
   - Agent C: Next.js - UI 展示 (暂缓)

2. **契约驱动开发**
   - 数据库层通过 `database.types.ts` 导出类型
   - 计算引擎通过 `ts-rs` 导出 TypeScript 绑定
   - 各层通过类型契约解耦

---

### Agent A: 数据库层实现细节

#### 创建的表结构

| 表名 | 用途 | 关键字段 |
|------|------|---------|
| `tags_registry` | 标签注册表 | tag_key, category, parents[], display_name |
| `attributes_meta` | 属性元数据 | attr_key, value_type, is_local, requirements[] |
| `items_meta` | 装备基底 | base_type, slot, is_two_handed, implicit_stats |
| `affixes` | 打造词缀 | affix_group, tier, min_val, max_val, stats |
| `unique_items` | 传奇装备 | id, base_type, slot, is_limited |
| `unique_affixes` | 传奇词缀 | item_id, variant_type, stats |
| `skills` | 技能数据 | skill_type, effectiveness, growth_table |
| `support_skill_modifiers` | 辅助技能加成 | mana_multiplier, injected_tags |
| `hero_traits` | 英雄特性 (占位) | hero_class, trait_type, stats |
| `hero_memories` | 英雄追忆 (占位) | slot, tier, special_effect |
| `pacts` | 石板 (占位) | pact_type, stats |
| `conversion_rules` | 转化 DAG | from_type, to_type, priority |
| `target_configs` | 目标预设 | resistances, generic_dr, armor |

#### 命名空间规范

采用 `dot.notation` 全小写格式：

```
dmg.phys.min      # 物理伤害下限
mod.inc.dmg.fire  # 火焰伤害增加 (Increased)
mod.more.dmg.all  # 总伤害提高 (More)
conv.phys_to_fire # 物理转火焰
extra.phys_as_fire # 物理额外获得火焰
```

**重要约定**: 所有百分比存储为小数 (0.15 = 15%)

#### 设计决策记录

1. **为什么使用 JSONB 存储 stats?**
   - 灵活性：词缀/技能属性组合多变
   - 性能：PostgreSQL JSONB 索引支持良好
   - 缺点：类型安全需要在应用层保证

2. **为什么 unique_affixes 有 variant_type?**
   - 支持侵蚀 (Corrupted) 变体
   - 同一传奇装备的词缀可以有不同版本

3. **hero_traits 和 hero_memories 为何是占位?**
   - 游戏机制复杂，需要更多游戏数据
   - 当前优先实现核心计算流程

---

### Agent B: 计算引擎实现细节

#### 模块结构

```
tli-core/src/
├── lib.rs       # WASM 入口，导出 calculate() 函数
├── types.rs     # 核心类型 (CalculatorInput/Output)
├── tags.rs      # 标签系统 (Interning + BitSet)
├── stats.rs     # 属性聚合器
├── conversion.rs # 伤害转化引擎
├── pipeline.rs  # 完整计算管线
└── utils.rs     # 工具函数
```

#### 核心算法实现

##### 1. 标签整数化 (Tag Interning)

**问题**: WASM 中字符串比较开销大
**解决**: 预加载标签注册表，建立 `HashMap<String, u32>` 映射

```rust
// 运行时所有标签操作使用 u32
let fire_id = registry.get_id("Tag_Fire"); // -> 21
let is_fire = tag_set.contains(21);
```

##### 2. 继承展开 (Inheritance Expansion)

**问题**: `Tag_Fire` 应该自动匹配 `Tag_Elemental` 和 `Tag_Damage` 的增伤
**解决**: 预计算每个标签的完整祖先集

```rust
// Tag_Fire(21) 展开为 [21, 20, 1]
// 21=Fire, 20=Elemental, 1=Damage
let expanded = registry.get_expanded_set(21);
```

##### 3. Tag Retention (标签记忆)

**核心机制**: 伤害转化后保留历史标签，可同时享受多种增伤

```rust
// 100 物理 → 50% 转火焰
// 结果:
//   50 物理 (tags: [Physical])
//   50 火焰 (tags: [Physical, Fire])  <- 关键！保留了 Physical
// 
// 应用增伤:
//   物理部分: 50 * (1 + phys_inc)
//   火焰部分: 50 * (1 + phys_inc) * (1 + fire_inc)  <- 两个都生效
```

**实现方式**: `DamageWithTags` 结构体包含 `history_tags: FixedBitSet`

##### 4. Inc/More 修正系统

**Inc (Increased)**: 同类累加
```rust
total_inc = inc_phys + inc_elemental + inc_all;
damage *= (1.0 + total_inc);
```

**More (Multiplied)**: 按 bucket 分组后相乘
```rust
// bucket 0: skill more
// bucket 100+: support skill more (每个辅助独立 bucket)
damage *= more_bucket_0 * more_bucket_100 * more_bucket_101;
```

**设计原因**: 辅助技能的 More 应该独立相乘，而非累加

##### 5. 计算管线 (Pipeline)

8 阶段顺序执行：

```
1. Sanitization     - 装备槽位冲突处理 (双手武器互斥)
2. Stat Aggregation - 属性池聚合
3. Base Calculation - 基础伤害计算
4. Extra & Convert  - 额外获得 → 转化 (DAG 顺序)
5. Modification     - Inc/More 应用
6. Speed Layer      - 攻速/施法速度
7. Crit & Luck      - 暴击计算
8. Mitigation       - 命中、减伤、输出
```

#### 遇到的问题与解决

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 转化顺序错误 | 未按 DAG 执行 | 定义优先级: Phys→Lightning→Cold→Fire→Chaos |
| Local 属性计算错误 | 武器属性应先于全局计算 | 分离 `local_pool` 和 `global_pool` |
| More 重复计算 | 同 bucket 内应累加而非相乘 | 引入 `bucket_id` 分组机制 |
| 标签匹配性能差 | 字符串比较 | 整数化 + BitSet 集合运算 |

---

### TypeScript 绑定

使用 `ts-rs` crate 自动生成类型定义，确保前后端类型同步。

关键类型：
- `CalculatorInput`: 计算器输入
- `CalculatorOutput`: 计算结果
- `ItemData` / `SkillData`: 装备/技能数据
- `DamageBreakdown`: 伤害构成明细

---

## 待办事项 (TODO)

### 高优先级

- [ ] 补充更多技能数据 (从游戏中提取)
- [ ] 实现 DOT (持续伤害) 计算
- [ ] 实现 Lucky 机制 (取两次掷骰最高值)
- [ ] 完善 EHP 计算公式

### 中优先级

- [ ] 从数据库动态加载标签注册表
- [ ] 支持多目标 DPS 计算
- [ ] 实现 CD 恢复速度对 DPS 的影响
- [ ] 添加更多单元测试

### 低优先级

- [ ] 性能优化 (SIMD, 并行计算)
- [ ] 支持导出计算过程详细日志
- [ ] 考虑 WebWorker 集成方案

---

## 技术债务 (Tech Debt)

1. **硬编码的默认标签注册表**
   - 当前 `pipeline.rs` 中 `create_default_registry()` 是硬编码
   - 应该从数据库或 JSON 文件加载

2. **缺少完整的错误处理**
   - 部分 `unwrap()` 调用可能 panic
   - 应该返回 `Result` 类型

3. **测试覆盖不足**
   - 需要更多边界条件测试
   - 需要集成测试验证完整流程

---

## 变更日志

| 日期 | 版本 | 变更内容 |
|------|------|---------|
| 2024-12-09 | v0.1.0 | 初始实现 Agent A + Agent B |

---

## 参考资料

- [开发规划 V2.6](./火炬之光：无限%20BD%20决策辅助系统%20-%20开发规划%20(V2.6).md)
- [Maxroll D4 Planner](https://maxroll.gg/d4/planner) - UI 参考
- [Path of Exile Wiki - Damage Conversion](https://pathofexile.fandom.com/wiki/Damage_conversion) - 转化机制参考

---

*本文档由 AI Agent 生成并持续维护*

